{{- if eq .Values.store.engine "woocommerce" }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-woocommerce-setup
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "store.labels" . | nindent 4 }}
    app.kubernetes.io/component: setup
spec:
  backoffLimit: {{ .Values.woocommerce.setupJob.backoffLimit }}
  ttlSecondsAfterFinished: {{ .Values.woocommerce.setupJob.ttlSecondsAfterFinished }}
  template:
    metadata:
      labels:
        {{- include "store.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: setup
    spec:
      restartPolicy: OnFailure
      # to ensure proper permissions to access WordPress files and run wp-cli commands
      securityContext:
        fsGroup: 33  # www-data group
        runAsUser: 33  # www-data user
        runAsGroup: 33
      initContainers:
        - name: wait-for-wordpress
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for WordPress to become reachable..."
              WORDPRESS_SERVICE="{{ include "store.wordpress.serviceName" . }}"
              MAX_ATTEMPTS=60
              ATTEMPT=0
              
              while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
                # Use wget with --server-response to check HTTP status codes
                # Accept 200, 301, 302 as success (WordPress often redirects during setup)
                if wget --spider --timeout=5 --server-response "http://${WORDPRESS_SERVICE}" 2>&1 | grep -E "HTTP/.* (200|301|302)" > /dev/null; then
                  echo "WordPress is reachable (received valid HTTP response)"
                  exit 0
                fi
                echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS: WordPress not ready yet..."
                sleep 5
                ATTEMPT=$((ATTEMPT + 1))
              done
              
              echo "WordPress did not become reachable after $MAX_ATTEMPTS attempts"
              exit 1
      containers:
        - name: setup
          image: "{{ .Values.woocommerce.setupJob.image.repository }}:{{ .Values.woocommerce.setupJob.image.tag }}"
          imagePullPolicy: {{ .Values.woocommerce.setupJob.image.pullPolicy }}
          # Run as www-data user to match WordPress
          securityContext:
            runAsUser: 33
            runAsGroup: 33
            allowPrivilegeEscalation: false
          env:
            - name: WORDPRESS_DB_HOST
              value: "{{ include "store.mysql.serviceName" . }}:3306"
            - name: WORDPRESS_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-db-credentials
                  key: MYSQL_DATABASE
            - name: WORDPRESS_DB_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-db-credentials
                  key: MYSQL_USER
            - name: WORDPRESS_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-db-credentials
                  key: MYSQL_PASSWORD
            - name: WORDPRESS_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-admin-credentials
                  key: WORDPRESS_ADMIN_USER
            - name: WORDPRESS_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-admin-credentials
                  key: WORDPRESS_ADMIN_PASSWORD
            - name: WORDPRESS_ADMIN_EMAIL
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-admin-credentials
                  key: WORDPRESS_ADMIN_EMAIL
            - name: WORDPRESS_URL
              value: "{{ include "store.url" . }}"
            - name: WORDPRESS_SERVICE
              value: "{{ include "store.wordpress.serviceName" . }}"
            - name: STORE_NAME
              value: {{ .Values.store.name | quote }}
            - name: PHP_MEMORY_LIMIT
              value: "768M"
            - name: WP_CLI_PHP_ARGS
              value: "-d memory_limit=768M" # Forces PHP to stop ITSELF before K8s kills it
            - name: WP_MEMORY_LIMIT
              value: "768M"
          # Mount the WordPress volume
          volumeMounts:
            - name: wordpress-data
              mountPath: /var/www/html
          command:
            - sh
            - -c
            - |
              set -e
              
              echo "==================================="
              echo "WooCommerce Store Setup Job"
              echo "Store: ${STORE_NAME}"
              echo "URL: ${WORDPRESS_URL}"
              echo "==================================="
              
              # Clean up potentially corrupted cache/temp files
              echo ""
              echo "[PRE-SETUP] Cleaning WordPress cache and temp files..."
              rm -rf /var/www/html/wp-content/cache/* || true
              rm -rf /var/www/html/wp-content/upgrade/* || true
              rm -rf /var/www/html/wp-content/plugins/woocommerce/tmp/* || true
              echo "✓ Cache cleaned"

              # Ensure directories exist with correct permissions
              echo ""
              echo "[0/6] Setting up directories and permissions..."
              mkdir -p /var/www/html/wp-content/upgrade
              mkdir -p /var/www/html/wp-content/plugins
              mkdir -p /var/www/html/wp-content/uploads
              chmod 755 /var/www/html/wp-content/upgrade
              chmod 755 /var/www/html/wp-content/plugins

              # WordPress core installation
              echo ""
              echo "[1/6] Installing WordPress core..."
              if ! wp core is-installed --allow-root --path=/var/www/html; then
                wp core install \
                  --url="${WORDPRESS_URL}" \
                  --title="${STORE_NAME}" \
                  --admin_user="${WORDPRESS_ADMIN_USER}" \
                  --admin_password="${WORDPRESS_ADMIN_PASSWORD}" \
                  --admin_email="${WORDPRESS_ADMIN_EMAIL}" \
                  --allow-root \
                  --path=/var/www/html
                echo "✓ WordPress installed successfully"
              else
                echo "✓ WordPress already installed"
              fi
              
              # Install and activate WooCommerce
              echo ""
              echo "[2/6] Installing WooCommerce plugin..."
              if ! wp plugin is-installed woocommerce --allow-root --path=/var/www/html; then
                wp plugin install woocommerce --activate --allow-root --path=/var/www/html
                echo "✓ WooCommerce installed and activated"
              elif ! wp plugin is-active woocommerce --allow-root --path=/var/www/html; then
                wp plugin activate woocommerce --allow-root --path=/var/www/html
                echo "✓ WooCommerce activated"
              else
                echo "✓ WooCommerce already active"
              fi

              # Complete WooCommerce setup (skip wizard)
              echo ""
              echo "[3/6] Configuring WooCommerce basic settings..."
              # Use timeout to prevent hanging, and add error handling
              set +e  # Temporarily allow errors
              timeout 90 wp option update woocommerce_store_address "123 Store Street" --allow-root --path=/var/www/html || echo "⚠ Store address update timed out"
              timeout 60 wp option update woocommerce_store_city "Store City" --allow-root --path=/var/www/html || echo "⚠ Store city update timed out"
              timeout 60 wp option update woocommerce_default_country "US:CA" --allow-root --path=/var/www/html || echo "⚠ Country update timed out"
              timeout 60 wp option update woocommerce_store_postcode "12345" --allow-root --path=/var/www/html || echo "⚠ Postcode update timed out"
              timeout 60 wp option update woocommerce_currency "USD" --allow-root --path=/var/www/html || echo "⚠ Currency update timed out"
              timeout 60 wp option update woocommerce_calc_taxes "no" --allow-root --path=/var/www/html || echo "⚠ Tax calc update timed out"
              timeout 60 wp option update woocommerce_onboarding_profile '{"skipped":true}' --format=json --allow-root --path=/var/www/html || echo "⚠ Onboarding profile update timed out"
              timeout 60 wp option update woocommerce_coming_soon "no" --allow-root --path=/var/www/html || echo "⚠ Coming soon mode update timed out"
              timeout 60 wp option update woocommerce_store_pages_only "no" --allow-root --path=/var/www/html || echo "⚠ Store pages visibility update timed out"
              # Ensure the store is launched (not in coming soon mode)
              timeout 60 wp option delete woocommerce_admin_launch_your_store_tour_hidden --allow-root --path=/var/www/html 2>/dev/null || echo "⚠ Launch tour option not found (ok)"
              set -e  # Re-enable strict error checking
              echo "✓ WooCommerce basic settings configured"
              
              # Enable Cash on Delivery payment gateway
              echo ""
              echo "[4/6] Enabling Cash on Delivery payment gateway..."
              timeout 60 wp option update woocommerce_cod_settings '{"enabled":"yes","title":"Cash on Delivery","description":"Pay with cash upon delivery"}' --format=json --allow-root --path=/var/www/html || echo "⚠ COD settings update timed out"
              
              # Create sample products
              echo ""
              echo "[5/6] Creating sample products..."
              
              # Product 1: Premium T-Shirt
              PRODUCT1_EXISTS=$(wp post list --post_type=product --title="Premium T-Shirt" --format=count --allow-root --path=/var/www/html)
              if [ "$PRODUCT1_EXISTS" = "0" ]; then
                PRODUCT1_ID=$(wp wc product create \
                  --name="Premium T-Shirt" \
                  --type=simple \
                  --regular_price=29.99 \
                  --description="High-quality cotton t-shirt with premium feel" \
                  --short_description="Comfortable premium t-shirt" \
                  --status=publish \
                  --stock_quantity=100 \
                  --sku="TSHIRT-001" \
                  --user="${WORDPRESS_ADMIN_USER}" \
                  --porcelain \
                  --allow-root \
                  --path=/var/www/html)
                echo "✓ Created Product 1: Premium T-Shirt (ID: $PRODUCT1_ID)"
              else
                echo "✓ Product 1 already exists: Premium T-Shirt"
              fi
              
              # Product 2: Wireless Headphones
              PRODUCT2_EXISTS=$(wp post list --post_type=product --title="Wireless Headphones" --format=count --allow-root --path=/var/www/html)
              if [ "$PRODUCT2_EXISTS" = "0" ]; then
                PRODUCT2_ID=$(wp wc product create \
                  --name="Wireless Headphones" \
                  --type=simple \
                  --regular_price=79.99 \
                  --description="Premium wireless headphones with noise cancellation and 30-hour battery life" \
                  --short_description="Wireless headphones with great sound" \
                  --status=publish \
                  --stock_quantity=50 \
                  --sku="HEADPHONES-001" \
                  --user="${WORDPRESS_ADMIN_USER}" \
                  --porcelain \
                  --allow-root \
                  --path=/var/www/html)
                echo "✓ Created Product 2: Wireless Headphones (ID: $PRODUCT2_ID)"
              else
                echo "✓ Product 2 already exists: Wireless Headphones"
              fi
              
              # Set permalinks
              echo ""
              echo "[6/6] Configuring permalinks..."
              wp rewrite structure '/%postname%/' --allow-root --path=/var/www/html
              wp rewrite flush --allow-root --path=/var/www/html
              echo "✓ Permalinks configured"

              # Final verification
              echo ""
              echo "==================================="
              echo "Running final verification checks..."
              echo "==================================="
              
              # Check 1: WordPress installed
              if ! wp core is-installed --allow-root --path=/var/www/html; then
                echo "✗ FAILED: WordPress not installed"
                exit 1
              fi
              echo "✓ WordPress: Installed"
              
              # Check 2: WooCommerce active
              if ! wp plugin is-active woocommerce --allow-root --path=/var/www/html; then
                echo "✗ FAILED: WooCommerce not active"
                exit 1
              fi
              echo "✓ WooCommerce: Active"
              
              # Check 3: Products exist
              FINAL_PRODUCT_COUNT=$(wp post list --post_type=product --post_status=publish --format=count --allow-root --path=/var/www/html)
              if [ "$FINAL_PRODUCT_COUNT" -lt 2 ]; then
                echo "✗ FAILED: Insufficient products (found $FINAL_PRODUCT_COUNT, need at least 2)"
                exit 1
              fi
              echo "✓ Products: $FINAL_PRODUCT_COUNT published"
              
              # Check 4: COD enabled
              FINAL_COD_CHECK=$(wp option get woocommerce_cod_settings --format=json --allow-root --path=/var/www/html | grep -o '"enabled":"yes"' || echo "")
              if [ -z "$FINAL_COD_CHECK" ]; then
                echo "✗ FAILED: Cash on Delivery not enabled"
                exit 1
              fi
              echo "✓ Cash on Delivery: Enabled"
              
              echo ""
              echo "==================================="
              echo "✓ WooCommerce store setup completed successfully!"
              echo "==================================="
              echo "Store URL: ${WORDPRESS_URL}"
              echo "Admin URL: ${WORDPRESS_URL}/wp-admin"
              echo "Admin User: ${WORDPRESS_ADMIN_USER}"
              echo "Products: $FINAL_PRODUCT_COUNT"
              echo "Payment Methods: Cash on Delivery"
              echo "==================================="
              
              exit 0
          resources:
            {{- toYaml .Values.woocommerce.setupJob.resources | nindent 12 }}
      # Volumes section to mount WordPress PVC
      volumes:
        - name: wordpress-data
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-wordpress-pvc
{{- end }}

